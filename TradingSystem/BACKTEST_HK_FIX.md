# 回测界面港股代码修复说明

## 🐛 **问题描述**

之前在回测界面输入港股纯数字代码（如 `01797`）时会报错，因为系统无法识别这是港股代码，缺少 `HK.` 前缀。

**错误示例**：
```
输入: 01797
错误: 数据必须包含 'date'列 (数据获取失败)
```

---

## ✅ **修复内容**

### **1. 添加市场选择器**

在"基本参数"组添加了**市场**下拉框：
- 🇺🇸 **美股** - 股票代码为字母（如 TSLA, AAPL, NVDA）
- 🇭🇰 **港股** - 股票代码为数字（如 01797, 00700）

### **2. 智能代码格式化**

系统会根据市场类型自动格式化股票代码：

#### **港股格式化**
```python
输入: 01797     → 输出: HK.01797
输入: 1797      → 输出: HK.01797
输入: 700       → 输出: HK.00700
输入: HK.01797  → 输出: HK.01797 (已有前缀，保持不变)
```

#### **美股格式化**
```python
输入: TSLA      → 输出: TSLA
输入: tsla      → 输出: TSLA (自动大写)
输入: HK.01797  → 输出: 01797 (移除错误的HK.前缀)
```

### **3. 友好提示**

- **占位符文本**:
  - 美股: "输入字母代码，如 TSLA"
  - 港股: "输入数字代码，如 01797"

- **状态栏提示**:
  - 代码格式化后会显示: "代码已格式化: 01797 → HK.01797"

---

## 📝 **使用方法**

### **回测港股（东方甄选示例）**

1. 选择市场: **港股**
2. 输入代码: `01797` 或 `1797`
3. 设置日期范围: 如 `2024-01-01` 到 `2025-01-27`
4. 点击"开始回测"

系统会自动格式化为 `HK.01797` 并获取数据。

### **回测美股（特斯拉示例）**

1. 选择市场: **美股**
2. 输入代码: `TSLA` 或 `tsla`
3. 设置日期范围
4. 点击"开始回测"

系统会自动转为大写 `TSLA`。

---

## 🔧 **技术实现**

### **核心方法: `format_stock_code()`**

```python
def format_stock_code(self, code, market):
    """
    格式化股票代码
    
    Parameters:
    -----------
    code : str
        原始代码
    market : str
        市场（'美股' 或 '港股'）
    
    Returns:
    --------
    str : 格式化后的代码
    """
    code = code.strip().upper()
    
    if market == '港股':
        # 港股处理
        if code.startswith('HK.'):
            # 已经有HK.前缀
            return code
        else:
            # 纯数字，添加HK.前缀
            try:
                num = int(code)
                return f"HK.{num:05d}"  # 补齐5位
            except ValueError:
                return f"HK.{code}"
    else:
        # 美股处理
        if code.startswith('HK.'):
            # 移除HK.前缀（用户可能切换了市场）
            return code.replace('HK.', '')
        else:
            return code
```

### **市场切换回调**

```python
def on_market_changed(self, market):
    """市场选择变化回调"""
    if market == '美股':
        self.stock_code_input.setPlaceholderText("输入字母代码，如 TSLA")
    else:  # 港股
        self.stock_code_input.setPlaceholderText("输入数字代码，如 01797")
```

---

## 📊 **测试用例**

### **港股测试**

| 输入 | 输出 | 说明 |
|------|------|------|
| `01797` | `HK.01797` | ✅ 自动添加前缀 |
| `1797` | `HK.01797` | ✅ 自动补齐5位 |
| `700` | `HK.00700` | ✅ 自动补齐5位 |
| `HK.01797` | `HK.01797` | ✅ 保持不变 |

### **美股测试**

| 输入 | 输出 | 说明 |
|------|------|------|
| `TSLA` | `TSLA` | ✅ 保持不变 |
| `tsla` | `TSLA` | ✅ 自动大写 |
| `aapl` | `AAPL` | ✅ 自动大写 |

---

## 🎯 **常见港股代码**

| 股票 | 输入示例 | 格式化后 |
|------|---------|----------|
| 东方甄选 | `01797` | `HK.01797` |
| 腾讯控股 | `00700` | `HK.00700` |
| 阿里巴巴 | `09988` | `HK.09988` |
| 美团 | `03690` | `HK.03690` |
| 小米集团 | `01810` | `HK.01810` |

---

## ⚠️ **注意事项**

1. **港股代码必须是纯数字**
   - ✅ 正确: `01797`, `700`, `9988`
   - ❌ 错误: `TSL`, `ABC123`

2. **美股代码必须是字母**
   - ✅ 正确: `TSLA`, `AAPL`, `NVDA`
   - ❌ 错误: `01797`, `123`

3. **市场选择要正确**
   - 回测港股请选择"港股"
   - 回测美股请选择"美股"

4. **自动格式化**
   - 系统会自动格式化代码
   - 如果格式化后与输入不同，状态栏会显示提示

---

## 🚀 **更新内容**

### **文件修改**
```
✅ ui/widgets/backtest_widget.py
   - 添加市场选择器 (ComboBox)
   - 添加 format_stock_code() 方法
   - 添加 on_market_changed() 回调
   - 更新占位符文本
   - 在 start_backtest() 中调用格式化
```

### **代码行数**
```
新增: ~50行
修改: ~20行
总计: ~70行改动
```

---

## ✅ **验证步骤**

### **1. 测试港股回测**
```bash
1. 启动系统: python main.py
2. 点击"回测"标签页
3. 选择市场: 港股
4. 输入代码: 01797
5. 设置日期: 2024-01-01 到 2025-01-27
6. 点击"开始回测"
7. 观察: 状态栏显示 "代码已格式化: 01797 → HK.01797"
8. 结果: 回测成功，显示K线和收益曲线
```

### **2. 测试美股回测**
```bash
1. 选择市场: 美股
2. 输入代码: tsla
3. 点击"开始回测"
4. 观察: 代码自动转为 TSLA
5. 结果: 回测成功
```

---

## 📚 **相关文档**

- `backtest_widget.py` - 回测界面实现
- `data_manager.py` - 数据管理器（支持港股HK.前缀）
- `BACKTEST_FEATURE.md` - 回测功能说明

---

## 🎉 **问题已解决！**

✅ 港股代码格式化完成  
✅ 市场选择器添加完成  
✅ 友好提示完成  
✅ 兼容美股和港股  

**现在可以正常回测港股了！** 🚀

---

*最后更新: 2025-01-27*  
*版本: v1.0.1*  
*状态: ✅ 已修复*
