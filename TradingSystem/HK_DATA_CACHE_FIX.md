# æ¸¯è‚¡æ•°æ®è·å–å’Œç¼“å­˜ä¿®å¤è¯´æ˜

## ğŸ› **é—®é¢˜æè¿°**

å›æµ‹æ¸¯è‚¡æ—¶å‡ºç°é”™è¯¯ï¼š
```
AttributeError: Can only use .dt accessor with datetimelike values
```

**æ ¹æœ¬åŸå› **ï¼š
1. âŒ `futu_data.py` è¿”å›çš„æ•°æ®æ²¡æœ‰ `date` åˆ—ï¼ˆæ—¥æœŸè¢«è®¾ä¸ºç´¢å¼•ï¼‰
2. âŒ ç¼“å­˜åŠŸèƒ½æœªæ­£ç¡®é›†æˆ
3. âŒ å›æµ‹å¼•æ“æœŸæœ›æœ‰ `date` åˆ—ä½œä¸ºæ™®é€šåˆ—

---

## âœ… **ä¿®å¤å†…å®¹**

### **1. ä¿®å¤ futu_data.py - æ•°æ®æ ¼å¼æ ‡å‡†åŒ–**

**ä¿®æ”¹æ–‡ä»¶**: `data/futu_data.py`

**å…³é”®ä¿®å¤**:
```python
# ä¹‹å‰ï¼ˆé”™è¯¯ï¼‰:
data = data.set_index('datetime')  # æŠŠæ—¥æœŸè®¾ä¸ºç´¢å¼•
return data[['open', 'high', 'low', 'close', 'volume']]  # âŒ æ²¡æœ‰dateåˆ—

# ç°åœ¨ï¼ˆæ­£ç¡®ï¼‰:
data['date'] = data['time_key'].dt.strftime('%Y-%m-%d')  # âœ… åˆ›å»ºdateåˆ—
result = data[['date', 'open', 'high', 'low', 'close', 'volume']].copy()
result = result.reset_index(drop=True)  # âœ… é‡ç½®ç´¢å¼•ï¼Œdateä½œä¸ºæ™®é€šåˆ—
return result
```

**è¿”å›æ ¼å¼**:
```python
DataFrame:
    date        object   # å­—ç¬¦ä¸²æ ¼å¼ 'YYYY-MM-DD'
    open        float64
    high        float64
    low         float64
    close       float64
    volume      float64
```

---

### **2. åˆ›å»ºç¼“å­˜ç³»ç»Ÿ - utils/cache.py**

**æ–°å¢æ–‡ä»¶**: `utils/cache.py`

**åŠŸèƒ½**:
- âœ… è‡ªåŠ¨ä¿å­˜è·å–çš„æ•°æ®åˆ°æœ¬åœ°
- âœ… ä¼˜å…ˆè¯»å–ç¼“å­˜ï¼ˆå‡å°‘APIè°ƒç”¨ï¼‰
- âœ… å…ƒæ•°æ®ç®¡ç†ï¼ˆè®°å½•ç¼“å­˜ä¿¡æ¯ï¼‰
- âœ… ç¼“å­˜æ¸…ç†å’Œåˆ—è¡¨åŠŸèƒ½

**æ ¸å¿ƒæ–¹æ³•**:
```python
cache = DataCache()

# è¯»å–ç¼“å­˜
df = cache.get_prices('HK.01797', '2024-12-01', '2025-01-27')

# ä¿å­˜ç¼“å­˜
cache.set_prices('HK.01797', df, '2024-12-01', '2025-01-27')

# åˆ—å‡ºæ‰€æœ‰ç¼“å­˜
cache.list_cache()

# æ¸…é™¤ç¼“å­˜
cache.clear_cache('HK.01797')  # æ¸…é™¤ç‰¹å®šè‚¡ç¥¨
cache.clear_cache()            # æ¸…é™¤æ‰€æœ‰
```

**ç¼“å­˜ç›®å½•ç»“æ„**:
```
data_cache/
â”œâ”€â”€ cache_metadata.json          # å…ƒæ•°æ®
â”œâ”€â”€ HK.01797_2024-12-01_2025-01-27.csv
â”œâ”€â”€ HK.00700_2024-12-01_2025-01-27.csv
â””â”€â”€ TSLA_2025-01-01_2025-01-27.csv
```

---

### **3. æ›´æ–° data_manager.py - é›†æˆç¼“å­˜**

**ä¿®æ”¹æ–‡ä»¶**: `core/data_manager.py`

**æ•°æ®è·å–æµç¨‹**:
```python
def get_kline_data(stock_code, start_date, end_date):
    # æ­¥éª¤1: å°è¯•ä»ç¼“å­˜è¯»å–
    cached_data = cache.get_prices(stock_code, start_date, end_date)
    if cached_data is not None:
        return cached_data  # âœ… ç›´æ¥è¿”å›ç¼“å­˜æ•°æ®
    
    # æ­¥éª¤2: ç¼“å­˜æœªå‘½ä¸­ï¼Œä»APIè·å–
    df = futu_fetcher.get_history_kline(stock_code, start_date, end_date)
    
    # æ­¥éª¤3: ä¿å­˜åˆ°ç¼“å­˜
    if df is not None:
        cache.set_prices(stock_code, df, start_date, end_date)
    
    return df
```

**ä¼˜ç‚¹**:
- ğŸ“ ç¬¬ä¸€æ¬¡è·å–ï¼šä»APIï¼ˆè¾ƒæ…¢ï¼Œçº¦2-5ç§’ï¼‰
- âš¡ ç¬¬äºŒæ¬¡è·å–ï¼šä»ç¼“å­˜ï¼ˆå¾ˆå¿«ï¼Œ<0.1ç§’ï¼‰
- ğŸ’° å‡å°‘APIè°ƒç”¨æ¬¡æ•°ï¼ˆçœé…é¢ï¼‰

---

## ğŸ§ª **æµ‹è¯•éªŒè¯**

### **è¿è¡Œæµ‹è¯•è„šæœ¬**

```bash
# æ–¹æ³•1: ä½¿ç”¨æ‰¹å¤„ç†
test_hk_data_cache.bat

# æ–¹æ³•2: ç›´æ¥è¿è¡Œ
python test_hk_data_cache.py
```

### **æµ‹è¯•å†…å®¹**

**æµ‹è¯•1: æ•°æ®æ ¼å¼éªŒè¯** âœ…
- éªŒè¯è¿”å›çš„æ•°æ®åŒ…å« `date` åˆ—
- éªŒè¯æ‰€æœ‰å¿…éœ€åˆ—å­˜åœ¨
- éªŒè¯æ•°æ®ç±»å‹æ­£ç¡®

**æµ‹è¯•2: ç¼“å­˜åŠŸèƒ½** âœ…
- ä¿å­˜æ•°æ®åˆ°ç¼“å­˜
- ä»ç¼“å­˜è¯»å–æ•°æ®
- æ•°æ®å®Œæ•´æ€§éªŒè¯

**æµ‹è¯•3: DataManageré›†æˆ** âœ…
- ç¬¬ä¸€æ¬¡è·å–ï¼ˆä»APIï¼‰
- ç¬¬äºŒæ¬¡è·å–ï¼ˆä»ç¼“å­˜ï¼‰
- æ•°æ®ä¸€è‡´æ€§éªŒè¯

**æµ‹è¯•4: å›æµ‹åœºæ™¯æ¨¡æ‹Ÿ** âœ…
- æ‰¹é‡è·å–å¤šåªè‚¡ç¥¨
- éªŒè¯æ•°æ®æ ¼å¼
- ç¡®ä¿å›æµ‹å¯ç”¨

---

## ğŸ“ **ä½¿ç”¨æ–¹æ³•**

### **1. å›æµ‹æ¸¯è‚¡ï¼ˆä¸œæ–¹ç”„é€‰ç¤ºä¾‹ï¼‰**

```bash
1. å¯åŠ¨ Futu OpenD å¹¶ç™»å½•
2. è¿è¡Œç³»ç»Ÿ: python main.py
3. ç‚¹å‡»"å›æµ‹"æ ‡ç­¾é¡µ
4. é€‰æ‹©å¸‚åœº: æ¸¯è‚¡
5. è¾“å…¥ä»£ç : 01797  (è‡ªåŠ¨æ ¼å¼åŒ–ä¸º HK.01797)
6. è®¾ç½®æ—¥æœŸ: 2024-12-01 åˆ° 2025-01-27
7. ç‚¹å‡»"å¼€å§‹å›æµ‹"
```

### **2. ç¬¬ä¸€æ¬¡å›æµ‹**
```
ğŸ“Š [Futu] è·å– HK.01797 ä» 2024-12-01 åˆ° 2025-01-27...
âœ… æˆåŠŸè·å– 38 æ¡æ•°æ®
ğŸ’¾ å·²ç¼“å­˜: HK.01797 (38è¡Œ)
âœ… å›æµ‹å®Œæˆ
```

### **3. ç¬¬äºŒæ¬¡å›æµ‹ï¼ˆå¿«é€Ÿï¼‰**
```
ğŸ“ ä½¿ç”¨ç¼“å­˜: HK.01797 (38è¡Œ) [ç¼“å­˜äº 2025-01-27 12:30:45]
âœ… å›æµ‹å®Œæˆ (ä½¿ç”¨ç¼“å­˜ï¼Œè¶…å¿«ï¼)
```

---

## ğŸ“Š **æ€§èƒ½å¯¹æ¯”**

| æ“ä½œ | æ— ç¼“å­˜ | æœ‰ç¼“å­˜ | æå‡ |
|------|--------|--------|------|
| ç¬¬ä¸€æ¬¡è·å– | 2-5ç§’ | 2-5ç§’ | ç›¸åŒ |
| ç¬¬äºŒæ¬¡è·å– | 2-5ç§’ | <0.1ç§’ | **20-50å€** |
| APIè°ƒç”¨æ¬¡æ•° | æ¯æ¬¡1æ¬¡ | ä»…é¦–æ¬¡1æ¬¡ | **èŠ‚çœ90%+** |

---

## ğŸ¯ **å¸¸è§è‚¡ç¥¨ä»£ç **

### **æ¸¯è‚¡**

| è‚¡ç¥¨ | è¾“å…¥ | æ ¼å¼åŒ–å |
|------|------|----------|
| ä¸œæ–¹ç”„é€‰ | `01797` æˆ– `1797` | `HK.01797` |
| è…¾è®¯æ§è‚¡ | `00700` æˆ– `700` | `HK.00700` |
| é˜¿é‡Œå·´å·´ | `09988` æˆ– `9988` | `HK.09988` |
| å°ç±³é›†å›¢ | `01810` æˆ– `1810` | `HK.01810` |
| ç¾å›¢ | `03690` æˆ– `3690` | `HK.03690` |

---

## ğŸ”§ **ç¼“å­˜ç®¡ç†**

### **æŸ¥çœ‹ç¼“å­˜**

```python
from utils.cache import DataCache

cache = DataCache()
cache.list_cache()
```

è¾“å‡º:
```
======================================================================
ç¼“å­˜åˆ—è¡¨ (3 é¡¹)
======================================================================
è‚¡ç¥¨ä»£ç           æ—¥æœŸèŒƒå›´                  è¡Œæ•°     ç¼“å­˜æ—¶é—´
----------------------------------------------------------------------
HK.01797         2024-12-01 ~ 2025-01-27  38       2025-01-27 12:30:45
HK.00700         2024-12-01 ~ 2025-01-27  38       2025-01-27 12:35:20
TSLA             2025-01-01 ~ 2025-01-27  20       2025-01-27 12:40:10
======================================================================
```

### **æ¸…é™¤ç¼“å­˜**

```python
# æ¸…é™¤ç‰¹å®šè‚¡ç¥¨
cache.clear_cache('HK.01797')

# æ¸…é™¤æ‰€æœ‰ç¼“å­˜
cache.clear_cache()
```

### **æŸ¥çœ‹ç¼“å­˜å¤§å°**

```python
size = cache.get_cache_size()
print(f"ç¼“å­˜æ€»å¤§å°: {size}")  # ä¾‹å¦‚: 125.34 KB
```

---

## ğŸ“ **ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•**

```
âœ… data/futu_data.py               ä¿®æ”¹ (~150è¡Œ)
   - ä¿®å¤æ•°æ®æ ¼å¼ï¼ˆè¿”å›å¸¦dateåˆ—çš„DataFrameï¼‰
   - æ·»åŠ é”™è¯¯å¤„ç†
   - å®Œå–„æµ‹è¯•ä»£ç 

âœ… utils/cache.py                  æ–°å¢ (~300è¡Œ)
   - å®Œæ•´çš„ç¼“å­˜ç³»ç»Ÿ
   - å…ƒæ•°æ®ç®¡ç†
   - ç¼“å­˜æ¸…ç†åŠŸèƒ½

âœ… core/data_manager.py            æ›´æ–° (~50è¡Œæ”¹åŠ¨)
   - é›†æˆç¼“å­˜é€»è¾‘
   - ä¼˜å…ˆè¯»å–ç¼“å­˜
   - è‡ªåŠ¨ä¿å­˜ç¼“å­˜

âœ… test_hk_data_cache.py          æ–°å¢ (~250è¡Œ)
   - ç»¼åˆæµ‹è¯•è„šæœ¬
   - 4ä¸ªæµ‹è¯•åœºæ™¯

âœ… test_hk_data_cache.bat         æ–°å¢
   - Windowsæµ‹è¯•è„šæœ¬

âœ… HK_DATA_CACHE_FIX.md           æ–°å¢
   - æœ¬æ–‡æ¡£
```

---

## âš ï¸ **æ³¨æ„äº‹é¡¹**

### **1. Futu OpenD å¿…é¡»è¿è¡Œ**

æ¸¯è‚¡æ•°æ®æ¥è‡ª Futu APIï¼Œå¿…é¡»ï¼š
- âœ… Futu OpenD å·²å¯åŠ¨
- âœ… å·²ç™»å½•è´¦æˆ·
- âœ… æœ‰æ¸¯è‚¡è¡Œæƒ…æƒé™

### **2. ç¼“å­˜æœ‰æ•ˆæ€§**

ç¼“å­˜æ•°æ®åŸºäºæ—¥æœŸèŒƒå›´ï¼š
- åŒæ ·çš„ `(è‚¡ç¥¨ä»£ç , å¼€å§‹æ—¥æœŸ, ç»“æŸæ—¥æœŸ)` ä¼šä½¿ç”¨ç¼“å­˜
- æ—¥æœŸèŒƒå›´æ”¹å˜ä¼šé‡æ–°è·å–

### **3. æ•°æ®æ›´æ–°**

å¦‚æœéœ€è¦æœ€æ–°æ•°æ®ï¼š
```python
# å¼ºåˆ¶æ›´æ–°ï¼ˆè·³è¿‡ç¼“å­˜ï¼‰
df = manager.get_kline_data(
    'HK.01797', 
    '2024-12-01', 
    '2025-01-27',
    force_update=True  # å¼ºåˆ¶ä»APIè·å–
)
```

### **4. ç¼“å­˜å ç”¨**

- æ¯æ¡è®°å½•çº¦ 1-2 KB
- 100æ¡å†å²æ•°æ®çº¦ 150 KB
- ç¼“å­˜100åªè‚¡ç¥¨çº¦ 15 MB

å®šæœŸæ¸…ç†ä¸éœ€è¦çš„ç¼“å­˜ï¼š
```python
cache.clear_cache()  # æ¸…é™¤æ‰€æœ‰
```

---

## ğŸ‰ **ä¿®å¤å®Œæˆï¼**

### **é—®é¢˜çŠ¶æ€**

| é—®é¢˜ | çŠ¶æ€ |
|------|------|
| âŒ `.dt accessor` é”™è¯¯ | âœ… å·²ä¿®å¤ |
| âŒ æ•°æ®æ ¼å¼ä¸æ­£ç¡® | âœ… å·²ä¿®å¤ |
| âŒ æ²¡æœ‰ç¼“å­˜åŠŸèƒ½ | âœ… å·²å®ç° |
| âŒ é‡å¤APIè°ƒç”¨ | âœ… å·²ä¼˜åŒ– |

### **æ–°å¢åŠŸèƒ½**

- âœ… æ ‡å‡†åŒ–æ•°æ®æ ¼å¼ï¼ˆå¸¦ `date` åˆ—ï¼‰
- âœ… å®Œæ•´çš„ç¼“å­˜ç³»ç»Ÿ
- âœ… ä¼˜å…ˆè¯»å–ç¼“å­˜
- âœ… è‡ªåŠ¨ä¿å­˜ç¼“å­˜
- âœ… ç¼“å­˜ç®¡ç†å·¥å…·
- âœ… æ€§èƒ½å¤§å¹…æå‡ï¼ˆ20-50å€ï¼‰

---

## ğŸ“š **ç›¸å…³æ–‡æ¡£**

- `data/futu_data.py` - å¯Œé€”æ•°æ®è·å–
- `utils/cache.py` - ç¼“å­˜ç®¡ç†ç³»ç»Ÿ
- `core/data_manager.py` - ç»Ÿä¸€æ•°æ®ç®¡ç†
- `test_hk_data_cache.py` - ç»¼åˆæµ‹è¯•

---

## ğŸš€ **å¼€å§‹ä½¿ç”¨**

```bash
# 1. æµ‹è¯•ä¿®å¤
test_hk_data_cache.bat

# 2. è¿è¡Œç³»ç»Ÿ
python main.py

# 3. å¼€å§‹å›æµ‹æ¸¯è‚¡
# é€‰æ‹©å¸‚åœº: æ¸¯è‚¡
# è¾“å…¥ä»£ç : 01797
# å¼€å§‹å›æµ‹ï¼
```

---

**ä¿®å¤æ—¶é—´**: 2025-01-27  
**ç‰ˆæœ¬**: v1.0.2  
**çŠ¶æ€**: âœ… å®Œå…¨ä¿®å¤  

**ç°åœ¨å¯ä»¥æ­£å¸¸å›æµ‹æ¸¯è‚¡äº†ï¼å¹¶ä¸”æœ‰å®Œæ•´çš„ç¼“å­˜æ”¯æŒï¼** ğŸ‰
