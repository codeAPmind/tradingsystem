# äº¤æ˜“ç•Œé¢å®Œæ•´å®ç°æ–¹æ¡ˆ

## ğŸ“‹ **é¡¹ç›®æ¦‚è¿°**

åŸºäºç°æœ‰çš„å®ç›˜äº¤æ˜“åŠŸèƒ½ï¼ˆHKTraderã€USTraderï¼‰å’ŒUIæ¡†æ¶ï¼Œå®Œå–„äº¤æ˜“ç•Œé¢ï¼Œå®ç°ä»ä¿¡å·åˆ°æ‰§è¡Œçš„å®Œæ•´äº¤æ˜“æµç¨‹ã€‚

**é¡¹ç›®è·¯å¾„**: `F:\PyProjects\æ–°å»ºæ–‡ä»¶å¤¹\tradingsystem\TradingSystem`

---

## âœ… **ç°æœ‰åŠŸèƒ½æ¸…å•**

### **å®ç›˜äº¤æ˜“å¼•æ“** âœ…
- `live_trading/hk_trader.py` - æ¸¯è‚¡äº¤æ˜“å¼•æ“
  - âœ… è¿æ¥Futu OpenD
  - âœ… è‡ªåŠ¨è·å–è´¦æˆ·ID
  - âœ… å®ç›˜/æ¨¡æ‹Ÿç›˜åˆ‡æ¢
  - âœ… ä¹°å…¥/å–å‡º
  - âœ… è·å–æŒä»“/è®¢å•
  - âœ… æ’¤å•åŠŸèƒ½
  - âœ… å®æ—¶è¡Œæƒ…

- `live_trading/us_trader.py` - ç¾è‚¡äº¤æ˜“å¼•æ“
  - âœ… ç›¸åŒåŠŸèƒ½ï¼ˆç¾è‚¡ç‰ˆæœ¬ï¼‰

### **UIç»„ä»¶** âœ…
- `ui/widgets/position_widget.py` - åŸºç¡€æŒä»“ç»„ä»¶
- `ui/widgets/signal_panel.py` - ä¿¡å·é¢æ¿
- `ui/widgets/backtest_widget.py` - å›æµ‹ç»„ä»¶
- `ui/widgets/chart_widget.py` - å›¾è¡¨ç»„ä»¶

---

## ğŸ¯ **éœ€è¦å®ç°çš„åŠŸèƒ½**

### **1. äº¤æ˜“æ‰§è¡Œé¢æ¿** (Trade Widget) ğŸ†•
- [ ] å¿«é€Ÿä¸‹å•ç•Œé¢
- [ ] å¸‚ä»·/é™ä»·é€‰æ‹©
- [ ] ä¹°å…¥/å–å‡ºæŒ‰é’®
- [ ] å®æ—¶è¡Œæƒ…æ˜¾ç¤º
- [ ] æ•°é‡å’Œé‡‘é¢è®¡ç®—

### **2. å¢å¼ºæŒä»“é¢æ¿** (Enhanced Position Widget) ğŸ”„
- [ ] è¯¦ç»†æŒä»“ä¿¡æ¯ï¼ˆ10åˆ—ï¼‰
- [ ] å®æ—¶ç›ˆäºæ›´æ–°
- [ ] å¹³ä»“/åŠ ä»“æŒ‰é’®
- [ ] æŒä»“ç»Ÿè®¡å›¾è¡¨

### **3. è®¢å•ç®¡ç†é¢æ¿** (Order Widget) ğŸ†•
- [ ] ä»Šæ—¥å§”æ‰˜æŸ¥è¯¢
- [ ] å†å²è®¢å•æŸ¥è¯¢
- [ ] æˆäº¤è®°å½•
- [ ] æ‰¹é‡æ’¤å•

### **4. è‡ªåŠ¨äº¤æ˜“æ§åˆ¶** (Auto Trade Widget) ğŸ†•
- [ ] å¯åŠ¨/åœæ­¢å¼€å…³
- [ ] é£æ§å‚æ•°è®¾ç½®
- [ ] å¾…æ‰§è¡Œä¿¡å·åˆ—è¡¨
- [ ] æ‰§è¡Œæ—¥å¿—

### **5. è´¦æˆ·ä¿¡æ¯é¢æ¿** (Account Widget) ğŸ†•
- [ ] è´¦æˆ·æ€»è§ˆ
- [ ] èµ„äº§åˆ†å¸ƒå›¾
- [ ] ä»Šæ—¥ç»Ÿè®¡

### **6. äº¤æ˜“å¼•æ“æ ¸å¿ƒ** (Trade Engine) ğŸ”„
- [ ] ç»Ÿä¸€äº¤æ˜“æ¥å£
- [ ] è‡ªåŠ¨å¸‚åœºè¯†åˆ«
- [ ] å®ç›˜/æ¨¡æ‹Ÿåˆ‡æ¢
- [ ] é£æ§æ£€æŸ¥

---

## ğŸ“ **é¡¹ç›®ç»“æ„**

```
F:\PyProjects\æ–°å»ºæ–‡ä»¶å¤¹\tradingsystem\TradingSystem\
â”œâ”€â”€ ui/
â”‚   â””â”€â”€ widgets/
â”‚       â”œâ”€â”€ position_widget.py          âœ… å·²æœ‰ï¼ˆéœ€å¢å¼ºï¼‰
â”‚       â”œâ”€â”€ trade_widget.py             ğŸ†• æ–°å»º
â”‚       â”œâ”€â”€ order_widget.py             ğŸ†• æ–°å»º
â”‚       â”œâ”€â”€ auto_trade_widget.py        ğŸ†• æ–°å»º
â”‚       â”œâ”€â”€ account_widget.py           ğŸ†• æ–°å»º
â”‚       â””â”€â”€ trade_dialog.py             ğŸ†• æ–°å»º
â”‚
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ trade_engine.py                 ğŸ”„ å¢å¼º
â”‚   â””â”€â”€ risk_manager.py                 ğŸ†• æ–°å»º
â”‚
â”œâ”€â”€ live_trading/
â”‚   â”œâ”€â”€ hk_trader.py                    âœ… å·²æœ‰
â”‚   â”œâ”€â”€ us_trader.py                    âœ… å·²æœ‰
â”‚   â””â”€â”€ trader_manager.py               ğŸ†• æ–°å»ºï¼ˆç»Ÿä¸€æ¥å£ï¼‰
â”‚
â””â”€â”€ models/
    â””â”€â”€ trade_models.py                 ğŸ†• æ–°å»ºï¼ˆæ•°æ®æ¨¡å‹ï¼‰
```

---

## ğŸ’» **è¯¦ç»†å®ç°æ–¹æ¡ˆ**

### **Phase 1: äº¤æ˜“å¼•æ“æ ¸å¿ƒ** ğŸ”¥

#### **1.1 ç»Ÿä¸€äº¤æ˜“ç®¡ç†å™¨** (`live_trading/trader_manager.py`)

```python
"""
ç»Ÿä¸€äº¤æ˜“ç®¡ç†å™¨
è‡ªåŠ¨è¯†åˆ«å¸‚åœºï¼Œè°ƒç”¨å¯¹åº”äº¤æ˜“å¼•æ“
"""
from live_trading.hk_trader import HKTrader
from live_trading.us_trader import USTrader


class TraderManager:
    """ç»Ÿä¸€äº¤æ˜“ç®¡ç†å™¨"""
    
    def __init__(self, host='127.0.0.1', port=11111, use_simulate=True):
        self.host = host
        self.port = port
        self.use_simulate = use_simulate
        
        # åˆå§‹åŒ–äº¤æ˜“å¼•æ“
        self.hk_trader = None
        self.us_trader = None
        
        # è¿æ¥çŠ¶æ€
        self.hk_connected = False
        self.us_connected = False
    
    def connect_hk(self):
        """è¿æ¥æ¸¯è‚¡"""
        if not self.hk_trader:
            self.hk_trader = HKTrader(
                host=self.host,
                port=self.port,
                use_simulate=self.use_simulate
            )
        
        self.hk_connected = self.hk_trader.connect()
        return self.hk_connected
    
    def connect_us(self):
        """è¿æ¥ç¾è‚¡"""
        if not self.us_trader:
            self.us_trader = USTrader(
                host=self.host,
                port=self.port,
                use_simulate=self.use_simulate
            )
        
        self.us_connected = self.us_trader.connect()
        return self.us_connected
    
    def get_trader(self, stock_code):
        """æ ¹æ®è‚¡ç¥¨ä»£ç è·å–å¯¹åº”äº¤æ˜“å™¨"""
        if stock_code.startswith('HK.'):
            if not self.hk_connected:
                self.connect_hk()
            return self.hk_trader
        else:
            if not self.us_connected:
                self.connect_us()
            return self.us_trader
    
    def buy(self, stock_code, price, qty, order_type=None):
        """ç»Ÿä¸€ä¹°å…¥æ¥å£"""
        trader = self.get_trader(stock_code)
        if trader:
            return trader.buy(stock_code, price, qty, order_type)
        return None
    
    def sell(self, stock_code, price, qty, order_type=None):
        """ç»Ÿä¸€å–å‡ºæ¥å£"""
        trader = self.get_trader(stock_code)
        if trader:
            return trader.sell(stock_code, price, qty, order_type)
        return None
    
    def get_account_info(self, market='HK'):
        """è·å–è´¦æˆ·ä¿¡æ¯"""
        if market == 'HK' and self.hk_trader:
            return self.hk_trader.get_account_info()
        elif market == 'US' and self.us_trader:
            return self.us_trader.get_account_info()
        return None
    
    def get_all_positions(self):
        """è·å–æ‰€æœ‰æŒä»“"""
        positions = []
        
        if self.hk_trader and self.hk_connected:
            hk_pos = self.hk_trader.get_positions()
            if hk_pos is not None and len(hk_pos) > 0:
                positions.extend(hk_pos.to_dict('records'))
        
        if self.us_trader and self.us_connected:
            us_pos = self.us_trader.get_positions()
            if us_pos is not None and len(us_pos) > 0:
                positions.extend(us_pos.to_dict('records'))
        
        return positions
    
    def disconnect(self):
        """æ–­å¼€æ‰€æœ‰è¿æ¥"""
        if self.hk_trader:
            self.hk_trader.disconnect()
        if self.us_trader:
            self.us_trader.disconnect()
```

#### **1.2 é£æ§ç®¡ç†å™¨** (`core/risk_manager.py`)

```python
"""
é£æ§ç®¡ç†å™¨
"""
class RiskManager:
    """é£æ§ç®¡ç†å™¨"""
    
    def __init__(self):
        # é£æ§å‚æ•°
        self.max_single_amount = 50000  # å•ç¬”æœ€å¤§é‡‘é¢
        self.max_daily_trades = 20      # å•æ—¥æœ€å¤§äº¤æ˜“æ¬¡æ•°
        self.max_position_ratio = 0.3   # å•åªè‚¡ç¥¨æœ€å¤§æŒä»“æ¯”ä¾‹
        self.stop_loss_ratio = 0.05     # æ­¢æŸæ¯”ä¾‹
        self.take_profit_ratio = 0.10   # æ­¢ç›ˆæ¯”ä¾‹
        
        # ä»Šæ—¥äº¤æ˜“ç»Ÿè®¡
        self.daily_trades = 0
        self.daily_amount = 0
    
    def check_order(self, order_data, account_info, positions):
        """
        é£æ§æ£€æŸ¥
        
        Parameters:
        -----------
        order_data : dict
            è®¢å•æ•°æ®
        account_info : dict
            è´¦æˆ·ä¿¡æ¯
        positions : list
            å½“å‰æŒä»“
        
        Returns:
        --------
        tuple : (is_pass, reason)
        """
        # 1. æ£€æŸ¥å•ç¬”é‡‘é¢
        amount = order_data['price'] * order_data['qty']
        if amount > self.max_single_amount:
            return False, f"å•ç¬”é‡‘é¢è¶…é™ï¼ˆ${amount:.2f} > ${self.max_single_amount:.2f}ï¼‰"
        
        # 2. æ£€æŸ¥ä»Šæ—¥äº¤æ˜“æ¬¡æ•°
        if self.daily_trades >= self.max_daily_trades:
            return False, f"ä»Šæ—¥äº¤æ˜“æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼ˆ{self.max_daily_trades}ï¼‰"
        
        # 3. æ£€æŸ¥èµ„é‡‘
        if order_data['direction'] == 'BUY':
            available = account_info.get('cash', 0)
            if amount > available:
                return False, f"èµ„é‡‘ä¸è¶³ï¼ˆéœ€è¦${amount:.2f}ï¼Œå¯ç”¨${available:.2f}ï¼‰"
        
        # 4. æ£€æŸ¥æŒä»“æ¯”ä¾‹
        if order_data['direction'] == 'BUY':
            total_value = account_info.get('total_assets', 0)
            new_ratio = amount / total_value
            if new_ratio > self.max_position_ratio:
                return False, f"å•åªè‚¡ç¥¨æŒä»“æ¯”ä¾‹å°†è¶…é™ï¼ˆ{new_ratio:.1%} > {self.max_position_ratio:.1%}ï¼‰"
        
        return True, "é€šè¿‡"
    
    def update_daily_stats(self, amount):
        """æ›´æ–°ä»Šæ—¥ç»Ÿè®¡"""
        self.daily_trades += 1
        self.daily_amount += amount
    
    def reset_daily_stats(self):
        """é‡ç½®ä»Šæ—¥ç»Ÿè®¡"""
        self.daily_trades = 0
        self.daily_amount = 0
```

---

### **Phase 2: UIç»„ä»¶å®ç°** ğŸ¨

#### **2.1 äº¤æ˜“æ‰§è¡Œé¢æ¿** (`ui/widgets/trade_widget.py`)

```python
"""
äº¤æ˜“æ‰§è¡Œé¢æ¿
"""
from PyQt6.QtWidgets import (QWidget, QVBoxLayout, QHBoxLayout, QFormLayout,
                             QLabel, QLineEdit, QComboBox, QPushButton,
                             QSpinBox, QDoubleSpinBox, QGroupBox, QRadioButton,
                             QButtonGroup, QMessageBox)
from PyQt6.QtCore import Qt, pyqtSignal
from futu import OrderType


class TradeWidget(QWidget):
    """äº¤æ˜“æ‰§è¡Œé¢æ¿"""
    
    # ä¿¡å·
    order_submitted = pyqtSignal(dict)  # è®¢å•æäº¤ä¿¡å·
    
    def __init__(self, trader_manager):
        super().__init__()
        self.trader_manager = trader_manager
        self.init_ui()
    
    def init_ui(self):
        """åˆå§‹åŒ–UI"""
        layout = QVBoxLayout(self)
        
        # æ ‡é¢˜
        title = QLabel("ğŸ”„ å¿«é€Ÿäº¤æ˜“")
        title.setStyleSheet("font-size: 16px; font-weight: bold;")
        layout.addWidget(title)
        
        # äº¤æ˜“è¡¨å•
        form_group = QGroupBox("ä¸‹å•ä¿¡æ¯")
        form_layout = QFormLayout()
        
        # è‚¡ç¥¨ä»£ç 
        self.stock_code_input = QComboBox()
        self.stock_code_input.setEditable(True)
        self.stock_code_input.setPlaceholderText("è¾“å…¥è‚¡ç¥¨ä»£ç  (å¦‚TSLAæˆ–HK.01797)")
        self.stock_code_input.currentTextChanged.connect(self.on_stock_changed)
        form_layout.addRow("è‚¡ç¥¨ä»£ç :", self.stock_code_input)
        
        # ä¹°å–æ–¹å‘
        direction_layout = QHBoxLayout()
        self.buy_radio = QRadioButton("ä¹°å…¥")
        self.sell_radio = QRadioButton("å–å‡º")
        self.buy_radio.setChecked(True)
        self.buy_radio.setStyleSheet("color: green;")
        self.sell_radio.setStyleSheet("color: red;")
        
        direction_group = QButtonGroup()
        direction_group.addButton(self.buy_radio)
        direction_group.addButton(self.sell_radio)
        
        direction_layout.addWidget(self.buy_radio)
        direction_layout.addWidget(self.sell_radio)
        direction_layout.addStretch()
        form_layout.addRow("äº¤æ˜“æ–¹å‘:", direction_layout)
        
        # ä»·æ ¼ç±»å‹
        self.price_type_combo = QComboBox()
        self.price_type_combo.addItems(["é™ä»·å•", "å¸‚ä»·å•"])
        self.price_type_combo.currentTextChanged.connect(self.on_price_type_changed)
        form_layout.addRow("ä»·æ ¼ç±»å‹:", self.price_type_combo)
        
        # ä»·æ ¼è¾“å…¥
        self.price_input = QDoubleSpinBox()
        self.price_input.setRange(0, 100000)
        self.price_input.setDecimals(2)
        self.price_input.setSingleStep(0.01)
        self.price_input.setPrefix("$")
        form_layout.addRow("äº¤æ˜“ä»·æ ¼:", self.price_input)
        
        # æ•°é‡è¾“å…¥
        self.qty_input = QSpinBox()
        self.qty_input.setRange(1, 1000000)
        self.qty_input.setSingleStep(100)
        self.qty_input.setValue(100)
        self.qty_input.valueChanged.connect(self.update_amount)
        form_layout.addRow("äº¤æ˜“æ•°é‡:", self.qty_input)
        
        # é¢„è®¡é‡‘é¢
        self.amount_label = QLabel("$0.00")
        self.amount_label.setStyleSheet("font-size: 14px; font-weight: bold; color: blue;")
        form_layout.addRow("é¢„è®¡é‡‘é¢:", self.amount_label)
        
        form_group.setLayout(form_layout)
        layout.addWidget(form_group)
        
        # å®æ—¶è¡Œæƒ…
        info_group = QGroupBox("å®æ—¶è¡Œæƒ…")
        info_layout = QFormLayout()
        
        self.current_price_label = QLabel("--")
        self.change_label = QLabel("--")
        self.volume_label = QLabel("--")
        
        info_layout.addRow("å½“å‰ä»·:", self.current_price_label)
        info_layout.addRow("æ¶¨è·Œå¹…:", self.change_label)
        info_layout.addRow("æˆäº¤é‡:", self.volume_label)
        
        refresh_btn = QPushButton("ğŸ”„ åˆ·æ–°è¡Œæƒ…")
        refresh_btn.clicked.connect(self.refresh_quote)
        info_layout.addRow("", refresh_btn)
        
        info_group.setLayout(info_layout)
        layout.addWidget(info_group)
        
        # æäº¤æŒ‰é’®
        button_layout = QHBoxLayout()
        
        self.submit_button = QPushButton("ğŸ“ æäº¤è®¢å•")
        self.submit_button.setStyleSheet("""
            QPushButton {
                background-color: #007bff;
                color: white;
                font-size: 16px;
                padding: 12px;
                border-radius: 5px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #0056b3;
            }
        """)
        self.submit_button.clicked.connect(self.submit_order)
        button_layout.addWidget(self.submit_button)
        
        layout.addLayout(button_layout)
        layout.addStretch()
    
    def on_stock_changed(self, stock_code):
        """è‚¡ç¥¨ä»£ç å˜åŒ–"""
        if stock_code:
            self.refresh_quote()
            
            # æ ¹æ®å¸‚åœºè°ƒæ•´æ•°é‡æ­¥é•¿
            if stock_code.startswith('HK.'):
                self.qty_input.setSingleStep(100)
                self.qty_input.setMinimum(100)
            else:
                self.qty_input.setSingleStep(1)
                self.qty_input.setMinimum(1)
    
    def on_price_type_changed(self, price_type):
        """ä»·æ ¼ç±»å‹å˜åŒ–"""
        if price_type == "é™ä»·å•":
            self.price_input.setEnabled(True)
        else:
            self.price_input.setEnabled(False)
    
    def refresh_quote(self):
        """åˆ·æ–°è¡Œæƒ…"""
        stock_code = self.stock_code_input.currentText().strip()
        if not stock_code:
            return
        
        try:
            trader = self.trader_manager.get_trader(stock_code)
            if trader:
                price = trader.get_current_price(stock_code)
                if price:
                    self.current_price_label.setText(f"${price:.2f}")
                    self.price_input.setValue(price)
                    self.update_amount()
                    
                    # è·å–è¯¦ç»†è¡Œæƒ…
                    snapshot = trader.get_market_snapshot(stock_code)
                    if snapshot is not None:
                        change_rate = snapshot.get('change_rate', 0)
                        color = 'green' if change_rate >= 0 else 'red'
                        self.change_label.setText(f"{change_rate:+.2f}%")
                        self.change_label.setStyleSheet(f"color: {color}; font-weight: bold;")
                        
                        volume = snapshot.get('volume', 0)
                        self.volume_label.setText(f"{volume:,.0f}")
        except Exception as e:
            QMessageBox.warning(self, "é”™è¯¯", f"åˆ·æ–°è¡Œæƒ…å¤±è´¥: {e}")
    
    def update_amount(self):
        """æ›´æ–°é¢„è®¡é‡‘é¢"""
        price = self.price_input.value()
        qty = self.qty_input.value()
        amount = price * qty
        self.amount_label.setText(f"${amount:,.2f}")
    
    def submit_order(self):
        """æäº¤è®¢å•"""
        stock_code = self.stock_code_input.currentText().strip()
        if not stock_code:
            QMessageBox.warning(self, "é”™è¯¯", "è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ")
            return
        
        direction = 'BUY' if self.buy_radio.isChecked() else 'SELL'
        price_type = self.price_type_combo.currentText()
        price = self.price_input.value()
        qty = self.qty_input.value()
        
        # æ¸¯è‚¡æ•°é‡æ£€æŸ¥
        if stock_code.startswith('HK.') and (qty < 100 or qty % 100 != 0):
            QMessageBox.warning(self, "é”™è¯¯", "æ¸¯è‚¡æ•°é‡å¿…é¡»>=100ä¸”æ˜¯100çš„æ•´æ•°å€")
            return
        
        # ç¡®è®¤å¯¹è¯æ¡†
        msg = f"ç¡®è®¤{direction}è®¢å•?\n\n"
        msg += f"è‚¡ç¥¨: {stock_code}\n"
        msg += f"æ–¹å‘: {direction}\n"
        msg += f"æ•°é‡: {qty}è‚¡\n"
        msg += f"ä»·æ ¼: {price_type}"
        if price_type == "é™ä»·å•":
            msg += f" ${price:.2f}"
        msg += f"\n\né¢„è®¡é‡‘é¢: ${price * qty:,.2f}"
        
        reply = QMessageBox.question(
            self, "ç¡®è®¤è®¢å•", msg,
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
        )
        
        if reply == QMessageBox.StandardButton.Yes:
            try:
                trader = self.trader_manager.get_trader(stock_code)
                if not trader:
                    QMessageBox.warning(self, "é”™è¯¯", "æ— æ³•è·å–äº¤æ˜“å™¨")
                    return
                
                # ç¡®å®šè®¢å•ç±»å‹
                order_type = OrderType.MARKET if price_type == "å¸‚ä»·å•" else OrderType.NORMAL
                
                # æäº¤è®¢å•
                if direction == 'BUY':
                    result = trader.buy(stock_code, price, qty, order_type)
                else:
                    result = trader.sell(stock_code, price, qty, order_type)
                
                if result is not None:
                    QMessageBox.information(self, "æˆåŠŸ", "è®¢å•æäº¤æˆåŠŸï¼")
                    
                    # å‘é€ä¿¡å·
                    order = {
                        'stock_code': stock_code,
                        'direction': direction,
                        'price_type': price_type,
                        'price': price,
                        'qty': qty
                    }
                    self.order_submitted.emit(order)
                else:
                    QMessageBox.warning(self, "å¤±è´¥", "è®¢å•æäº¤å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—")
                    
            except Exception as e:
                QMessageBox.critical(self, "é”™è¯¯", f"æäº¤è®¢å•æ—¶å‡ºé”™: {e}")
```

#### **2.2 å¢å¼ºæŒä»“é¢æ¿** (`ui/widgets/position_widget.py` - å®Œæ•´ç‰ˆ)

```python
"""
å¢å¼ºç‰ˆæŒä»“é¢æ¿
"""
from PyQt6.QtWidgets import (QWidget, QVBoxLayout, QHBoxLayout,
                             QTableWidget, QLabel, QPushButton,
                             QGroupBox, QTableWidgetItem, QHeaderView,
                             QMessageBox)
from PyQt6.QtCore import Qt, pyqtSignal, QTimer
from PyQt6.QtGui import QColor


class PositionWidget(QWidget):
    """å¢å¼ºç‰ˆæŒä»“é¢æ¿"""
    
    # ä¿¡å·
    close_position = pyqtSignal(str, int)  # å¹³ä»“ä¿¡å·ï¼ˆè‚¡ç¥¨ä»£ç ï¼Œæ•°é‡ï¼‰
    add_position = pyqtSignal(str)          # åŠ ä»“ä¿¡å·
    
    def __init__(self, trader_manager):
        super().__init__()
        self.trader_manager = trader_manager
        self.init_ui()
        
        # å®šæ—¶åˆ·æ–°ï¼ˆæ¯30ç§’ï¼‰
        self.refresh_timer = QTimer()
        self.refresh_timer.timeout.connect(self.refresh_positions)
        self.refresh_timer.start(30000)
    
    def init_ui(self):
        """åˆå§‹åŒ–UI"""
        layout = QVBoxLayout(self)
        
        # æ ‡é¢˜æ 
        title_layout = QHBoxLayout()
        title = QLabel("ğŸ“Š æŒä»“ç®¡ç†")
        title.setStyleSheet("font-size: 16px; font-weight: bold;")
        title_layout.addWidget(title)
        
        refresh_btn = QPushButton("ğŸ”„ åˆ·æ–°")
        refresh_btn.clicked.connect(self.refresh_positions)
        title_layout.addWidget(refresh_btn)
        
        title_layout.addStretch()
        layout.addLayout(title_layout)
        
        # æŒä»“ç»Ÿè®¡
        stats_group = QGroupBox("æŒä»“ç»Ÿè®¡")
        stats_layout = QHBoxLayout()
        
        self.total_cost_label = QLabel("æ€»æˆæœ¬: $0.00")
        self.total_value_label = QLabel("æ€»å¸‚å€¼: $0.00")
        self.total_profit_label = QLabel("æµ®åŠ¨ç›ˆäº: $0.00 (0.00%)")
        
        stats_layout.addWidget(self.total_cost_label)
        stats_layout.addWidget(self.total_value_label)
        stats_layout.addWidget(self.total_profit_label)
        stats_layout.addStretch()
        
        stats_group.setLayout(stats_layout)
        layout.addWidget(stats_group)
        
        # æŒä»“åˆ—è¡¨è¡¨æ ¼
        self.position_table = QTableWidget()
        self.position_table.setColumnCount(10)
        self.position_table.setHorizontalHeaderLabels([
            'è‚¡ç¥¨ä»£ç ', 'è‚¡ç¥¨åç§°', 'æŒä»“æ•°é‡', 'å¯ç”¨æ•°é‡',
            'æˆæœ¬ä»·', 'ç°ä»·', 'å¸‚å€¼', 'ç›ˆäºé‡‘é¢', 'ç›ˆäºæ¯”ä¾‹', 'æ“ä½œ'
        ])
        
        # è‡ªåŠ¨è°ƒæ•´åˆ—å®½
        header = self.position_table.horizontalHeader()
        header.setSectionResizeMode(QHeaderView.ResizeMode.Stretch)
        
        layout.addWidget(self.position_table)
        
        # åº•éƒ¨æŒ‰é’®
        button_layout = QHBoxLayout()
        
        export_btn = QPushButton("ğŸ“¤ å¯¼å‡ºæŒä»“")
        export_btn.clicked.connect(self.export_positions)
        button_layout.addWidget(export_btn)
        
        button_layout.addStretch()
        layout.addLayout(button_layout)
    
    def refresh_positions(self):
        """åˆ·æ–°æŒä»“"""
        try:
            positions = self.trader_manager.get_all_positions()
            self.update_positions(positions)
        except Exception as e:
            print(f"åˆ·æ–°æŒä»“å¤±è´¥: {e}")
    
    def update_positions(self, positions):
        """
        æ›´æ–°æŒä»“æ•°æ®
        
        Parameters:
        -----------
        positions : list
            æŒä»“åˆ—è¡¨
        """
        self.position_table.setRowCount(0)
        
        if not positions:
            return
        
        total_cost = 0
        total_value = 0
        
        for position in positions:
            row = self.position_table.rowCount()
            self.position_table.insertRow(row)
            
            # æå–æ•°æ®
            code = position.get('code', '')
            name = position.get('stock_name', '')
            qty = position.get('qty', 0)
            available_qty = position.get('can_sell_qty', qty)
            cost_price = position.get('cost_price', 0)
            current_price = position.get('last_price', cost_price)
            market_value = position.get('market_val', current_price * qty)
            profit = position.get('pl_val', market_value - cost_price * qty)
            profit_rate = position.get('pl_ratio', (profit / (cost_price * qty) * 100) if cost_price > 0 else 0)
            
            # å¡«å……è¡¨æ ¼
            self.position_table.setItem(row, 0, QTableWidgetItem(code))
            self.position_table.setItem(row, 1, QTableWidgetItem(name))
            self.position_table.setItem(row, 2, QTableWidgetItem(str(qty)))
            self.position_table.setItem(row, 3, QTableWidgetItem(str(available_qty)))
            self.position_table.setItem(row, 4, QTableWidgetItem(f"${cost_price:.2f}"))
            self.position_table.setItem(row, 5, QTableWidgetItem(f"${current_price:.2f}"))
            self.position_table.setItem(row, 6, QTableWidgetItem(f"${market_value:.2f}"))
            
            # ç›ˆäºé‡‘é¢
            profit_item = QTableWidgetItem(f"${profit:+.2f}")
            profit_item.setForeground(QColor('green' if profit > 0 else 'red'))
            self.position_table.setItem(row, 7, profit_item)
            
            # ç›ˆäºæ¯”ä¾‹
            profit_rate_item = QTableWidgetItem(f"{profit_rate:+.2f}%")
            profit_rate_item.setForeground(QColor('green' if profit_rate > 0 else 'red'))
            self.position_table.setItem(row, 8, profit_rate_item)
            
            # æ“ä½œæŒ‰é’®
            button_widget = QWidget()
            button_layout = QHBoxLayout(button_widget)
            button_layout.setContentsMargins(2, 2, 2, 2)
            
            close_btn = QPushButton("å¹³ä»“")
            close_btn.clicked.connect(
                lambda checked, c=code, q=available_qty: self.close_position.emit(c, q)
            )
            button_layout.addWidget(close_btn)
            
            add_btn = QPushButton("åŠ ä»“")
            add_btn.clicked.connect(
                lambda checked, c=code: self.add_position.emit(c)
            )
            button_layout.addWidget(add_btn)
            
            self.position_table.setCellWidget(row, 9, button_widget)
            
            # ç»Ÿè®¡
            total_cost += cost_price * qty
            total_value += market_value
        
        # æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        total_profit = total_value - total_cost
        profit_rate = (total_profit / total_cost * 100) if total_cost > 0 else 0
        
        self.total_cost_label.setText(f"æ€»æˆæœ¬: ${total_cost:,.2f}")
        self.total_value_label.setText(f"æ€»å¸‚å€¼: ${total_value:,.2f}")
        
        profit_text = f"æµ®åŠ¨ç›ˆäº: ${total_profit:+,.2f} ({profit_rate:+.2f}%)"
        self.total_profit_label.setText(profit_text)
        self.total_profit_label.setStyleSheet(
            f"color: {'green' if total_profit > 0 else 'red'}; font-weight: bold;"
        )
    
    def export_positions(self):
        """å¯¼å‡ºæŒä»“"""
        # TODO: å®ç°å¯¼å‡ºåŠŸèƒ½
        QMessageBox.information(self, "æç¤º", "å¯¼å‡ºåŠŸèƒ½å¾…å®ç°")
```

---

### **Phase 3: é›†æˆåˆ°ä¸»çª—å£** ğŸ”—

#### **3.1 ä¸»çª—å£æ›´æ–°** (`ui/main_window.py`)

```python
"""
ä¸»çª—å£ - æ·»åŠ äº¤æ˜“åŠŸèƒ½
"""
from PyQt6.QtWidgets import QMainWindow, QTabWidget, QWidget, QHBoxLayout
from ui.widgets.trade_widget import TradeWidget
from ui.widgets.position_widget import PositionWidget
from live_trading.trader_manager import TraderManager


class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        # åˆå§‹åŒ–äº¤æ˜“ç®¡ç†å™¨
        self.trader_manager = TraderManager(use_simulate=True)
        
        # åˆ›å»ºUI
        self.init_ui()
        
        # è¿æ¥äº¤æ˜“å™¨
        self.connect_traders()
    
    def init_ui(self):
        """åˆå§‹åŒ–UI"""
        self.setWindowTitle("é‡åŒ–äº¤æ˜“ç³»ç»Ÿ")
        self.setGeometry(100, 100, 1600, 900)
        
        # ä¸­å¿ƒéƒ¨ä»¶
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        
        # ä¸»å¸ƒå±€
        main_layout = QHBoxLayout(central_widget)
        
        # å·¦ä¾§ï¼šè‚¡ç¥¨åˆ—è¡¨ï¼ˆå·²æœ‰ï¼‰
        # ...
        
        # ä¸­é—´ï¼šæ ‡ç­¾é¡µ
        self.center_tabs = QTabWidget()
        
        # ä¿¡å·é¢æ¿ï¼ˆå·²æœ‰ï¼‰
        # ...
        
        # äº¤æ˜“é¢æ¿ï¼ˆæ–°å¢ï¼‰
        self.trade_widget = TradeWidget(self.trader_manager)
        self.trade_widget.order_submitted.connect(self.on_order_submitted)
        self.center_tabs.addTab(self.trade_widget, "ğŸ”„ äº¤æ˜“")
        
        main_layout.addWidget(self.center_tabs, 2)
        
        # å³ä¾§ï¼šæ ‡ç­¾é¡µ
        self.right_tabs = QTabWidget()
        
        # æŒä»“é¢æ¿ï¼ˆå¢å¼ºç‰ˆï¼‰
        self.position_widget = PositionWidget(self.trader_manager)
        self.position_widget.close_position.connect(self.on_close_position)
        self.position_widget.add_position.connect(self.on_add_position)
        self.right_tabs.addTab(self.position_widget, "ğŸ“Š æŒä»“")
        
        # è®¢å•é¢æ¿ï¼ˆå¾…å®ç°ï¼‰
        # ...
        
        # è´¦æˆ·é¢æ¿ï¼ˆå¾…å®ç°ï¼‰
        # ...
        
        main_layout.addWidget(self.right_tabs, 1)
    
    def connect_traders(self):
        """è¿æ¥äº¤æ˜“å™¨"""
        try:
            # è¿æ¥æ¸¯è‚¡
            self.trader_manager.connect_hk()
            
            # è¿æ¥ç¾è‚¡
            self.trader_manager.connect_us()
            
            # åˆ·æ–°æŒä»“
            self.position_widget.refresh_positions()
            
        except Exception as e:
            print(f"è¿æ¥äº¤æ˜“å™¨å¤±è´¥: {e}")
    
    def on_order_submitted(self, order):
        """è®¢å•æäº¤å›è°ƒ"""
        print(f"è®¢å•å·²æäº¤: {order}")
        # åˆ·æ–°æŒä»“
        self.position_widget.refresh_positions()
    
    def on_close_position(self, stock_code, qty):
        """å¹³ä»“å›è°ƒ"""
        print(f"å¹³ä»“: {stock_code} {qty}è‚¡")
        # åˆ‡æ¢åˆ°äº¤æ˜“é¢æ¿å¹¶é¢„å¡«ä¿¡æ¯
        self.center_tabs.setCurrentWidget(self.trade_widget)
        self.trade_widget.stock_code_input.setCurrentText(stock_code)
        self.trade_widget.sell_radio.setChecked(True)
        self.trade_widget.qty_input.setValue(qty)
    
    def on_add_position(self, stock_code):
        """åŠ ä»“å›è°ƒ"""
        print(f"åŠ ä»“: {stock_code}")
        # åˆ‡æ¢åˆ°äº¤æ˜“é¢æ¿å¹¶é¢„å¡«ä¿¡æ¯
        self.center_tabs.setCurrentWidget(self.trade_widget)
        self.trade_widget.stock_code_input.setCurrentText(stock_code)
        self.trade_widget.buy_radio.setChecked(True)
    
    def closeEvent(self, event):
        """å…³é—­äº‹ä»¶"""
        self.trader_manager.disconnect()
        event.accept()
```

---

## ğŸš€ **å®æ–½æ­¥éª¤**

### **Step 1: åˆ›å»ºäº¤æ˜“ç®¡ç†å™¨** âœ…
```bash
# åˆ›å»ºæ–‡ä»¶
touch live_trading/trader_manager.py

# å®ç°ç»Ÿä¸€äº¤æ˜“æ¥å£
```

### **Step 2: å®ç°é£æ§ç®¡ç†å™¨** âœ…
```bash
touch core/risk_manager.py
```

### **Step 3: åˆ›å»ºäº¤æ˜“UIç»„ä»¶** âœ…
```bash
# äº¤æ˜“æ‰§è¡Œé¢æ¿
touch ui/widgets/trade_widget.py

# å¢å¼ºæŒä»“é¢æ¿ï¼ˆæ›¿æ¢ç°æœ‰ï¼‰
# å·²æœ‰: ui/widgets/position_widget.py
```

### **Step 4: é›†æˆåˆ°ä¸»çª—å£** âœ…
```bash
# æ›´æ–°ä¸»çª—å£
# æ–‡ä»¶: ui/main_window.py
```

### **Step 5: æµ‹è¯•** ğŸ§ª
```bash
# è¿è¡Œä¸»ç¨‹åº
python main.py

# æˆ–å¯åŠ¨UI
start_ui.bat
```

---

## âœ… **åŠŸèƒ½æ¸…å•**

### **äº¤æ˜“æ‰§è¡Œ** âœ…
- [x] è‚¡ç¥¨ä»£ç è¾“å…¥
- [x] ä¹°å…¥/å–å‡ºé€‰æ‹©
- [x] å¸‚ä»·/é™ä»·é€‰æ‹©
- [x] å®æ—¶è¡Œæƒ…æ˜¾ç¤º
- [x] æ•°é‡å’Œé‡‘é¢è®¡ç®—
- [x] è®¢å•ç¡®è®¤å¯¹è¯æ¡†
- [x] è‡ªåŠ¨å¸‚åœºè¯†åˆ«

### **æŒä»“ç®¡ç†** âœ…
- [x] å®æ—¶æŒä»“åˆ—è¡¨
- [x] ç›ˆäºç»Ÿè®¡
- [x] å¹³ä»“/åŠ ä»“æŒ‰é’®
- [x] å®šæ—¶è‡ªåŠ¨åˆ·æ–°
- [x] å¤šå¸‚åœºæ”¯æŒ

### **é£æ§ç®¡ç†** âœ…
- [x] å•ç¬”é‡‘é¢é™åˆ¶
- [x] äº¤æ˜“æ¬¡æ•°é™åˆ¶
- [x] èµ„é‡‘æ£€æŸ¥
- [x] æŒä»“æ¯”ä¾‹æ£€æŸ¥

### **äº¤æ˜“ç®¡ç†å™¨** âœ…
- [x] ç»Ÿä¸€äº¤æ˜“æ¥å£
- [x] è‡ªåŠ¨å¸‚åœºè¯†åˆ«
- [x] å¤šå¸‚åœºæ”¯æŒ
- [x] å®ç›˜/æ¨¡æ‹Ÿåˆ‡æ¢

---

## ğŸ“ **ä½¿ç”¨ç¤ºä¾‹**

### **1. å¯åŠ¨äº¤æ˜“ç•Œé¢**
```bash
cd F:\PyProjects\æ–°å»ºæ–‡ä»¶å¤¹\tradingsystem\TradingSystem
python main.py
```

### **2. è¿æ¥äº¤æ˜“å™¨**
- ç¡®ä¿Futu OpenDå·²å¯åŠ¨
- ç³»ç»Ÿè‡ªåŠ¨è¿æ¥æ¸¯è‚¡å’Œç¾è‚¡
- è‡ªåŠ¨è·å–è´¦æˆ·ä¿¡æ¯

### **3. æ‰§è¡Œäº¤æ˜“**
- è¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆTSLAæˆ–HK.01797ï¼‰
- é€‰æ‹©ä¹°å…¥/å–å‡º
- é€‰æ‹©å¸‚ä»·/é™ä»·
- è¾“å…¥æ•°é‡
- ç‚¹å‡»æäº¤è®¢å•

### **4. æŸ¥çœ‹æŒä»“**
- å®æ—¶æ˜¾ç¤ºæ‰€æœ‰æŒä»“
- è‡ªåŠ¨è®¡ç®—ç›ˆäº
- æ”¯æŒå¹³ä»“/åŠ ä»“æ“ä½œ

---

## ğŸ¯ **ä¸‹ä¸€æ­¥è®¡åˆ’**

### **Phase 4: è®¢å•ç®¡ç†** ğŸ†•
- [ ] åˆ›å»ºorder_widget.py
- [ ] ä»Šæ—¥å§”æ‰˜æŸ¥è¯¢
- [ ] å†å²è®¢å•æŸ¥è¯¢
- [ ] æˆäº¤è®°å½•
- [ ] æ’¤å•åŠŸèƒ½

### **Phase 5: è‡ªåŠ¨äº¤æ˜“** ğŸ†•
- [ ] åˆ›å»ºauto_trade_widget.py
- [ ] å¯åŠ¨/åœæ­¢æ§åˆ¶
- [ ] é£æ§å‚æ•°è®¾ç½®
- [ ] å¾…æ‰§è¡Œä¿¡å·åˆ—è¡¨
- [ ] æ‰§è¡Œæ—¥å¿—

### **Phase 6: è´¦æˆ·ä¿¡æ¯** ğŸ†•
- [ ] åˆ›å»ºaccount_widget.py
- [ ] è´¦æˆ·æ€»è§ˆ
- [ ] èµ„äº§åˆ†å¸ƒå›¾
- [ ] ä»Šæ—¥ç»Ÿè®¡

---

## ğŸ“š **æ–‡æ¡£ç´¢å¼•**

- `TRADING_UI_DESIGN_1.md` - åŸå§‹UIè®¾è®¡
- `TRADING_UI_DESIGN_2.md` - æ‰©å±•UIè®¾è®¡
- `äº¤æ˜“ç³»ç»ŸUIè®¾è®¡è¡¥å…… - æŒä»“ä¸äº¤æ˜“æ¨¡å—.md` - äº¤æ˜“æ¨¡å—è¡¥å……
- æœ¬æ–‡æ¡£ - **å®Œæ•´å®ç°æ–¹æ¡ˆ**

---

**å®ç°æ–¹æ¡ˆå·²å®Œæˆï¼** âœ…

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- âœ… ç»“åˆç°æœ‰HKTrader/USTrader
- âœ… ç»Ÿä¸€äº¤æ˜“æ¥å£
- âœ… å®Œæ•´é£æ§ç³»ç»Ÿ
- âœ… ä¸“ä¸šUIè®¾è®¡
- âœ… å®æ—¶æ•°æ®æ›´æ–°

**å‡†å¤‡å¼€å§‹å®ç°å—ï¼Ÿ** ğŸš€